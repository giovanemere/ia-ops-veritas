<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Manager - IA-Ops Veritas</title>
    <link rel="stylesheet" href="http://localhost:8869/static/css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1>üìä Project Manager</h1>
                <div class="subtitle">Gesti√≥n Masiva de Proyectos de Testing</div>
            </div>
            <nav class="nav">
                <button onclick="VeritasUtils.showModal('createModal')" class="nav-item">+ Nuevo Proyecto</button>
                <a href="http://localhost:8869" class="nav-item">Portal Principal</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="nav-breadcrumb">
            <a href="http://localhost:8869">Portal</a> <span>/</span>
            <span>Project Manager</span>
        </div>

        <!-- Stats Section -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalProjects">0</div>
                <div class="stat-label">Proyectos Activos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalTestCases">0</div>
                <div class="stat-label">Casos de Prueba</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalUserStories">0</div>
                <div class="stat-label">Historias de Usuario</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">95%</div>
                <div class="stat-label">Tasa de √âxito</div>
            </div>
        </section>

        <!-- Projects List -->
        <section>
            <div class="flex justify-between items-center mb-3">
                <h2>Proyectos</h2>
                <div class="flex gap-2">
                    <button onclick="loadProjects()" class="btn btn-secondary">üîÑ Actualizar</button>
                    <button onclick="exportProjects()" class="btn btn-secondary">üìä Exportar</button>
                </div>
            </div>
            <div id="projectsList"></div>
        </section>
    </div>

    <!-- Create Project Modal -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Crear Nuevo Proyecto</h3>
                <button class="modal-close" onclick="VeritasUtils.hideModal('createModal')">&times;</button>
            </div>
            <form id="createProjectForm">
                <div class="form-group">
                    <label>Nombre del Proyecto:</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>URL del Repositorio:</label>
                    <input type="url" name="repository" required placeholder="https://github.com/user/repo.git">
                </div>
                <div class="form-group">
                    <label>Descripci√≥n:</label>
                    <textarea name="description" rows="3"></textarea>
                </div>
                <div class="flex gap-2 justify-end">
                    <button type="button" onclick="VeritasUtils.hideModal('createModal')" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn">Crear Proyecto</button>
                </div>
            </form>
        </div>
    </div>

    <script src="http://localhost:8869/static/js/veritas-utils.js"></script>
    <script>
        async function loadProjects() {
            try {
                VeritasUtils.showLoading('Cargando proyectos...');
                const projects = await VeritasUtils.get('projectManager', '/projects');
                
                document.getElementById('totalProjects').textContent = projects.length;
                
                let totalTestCases = 0;
                let totalUserStories = 0;
                
                projects.forEach(project => {
                    totalUserStories += (project.user_stories || []).length;
                    totalTestCases += (project.test_plans || []).reduce((sum, plan) => 
                        sum + (plan.test_cases || []).length, 0);
                });
                
                document.getElementById('totalTestCases').textContent = totalTestCases;
                document.getElementById('totalUserStories').textContent = totalUserStories;
                
                renderProjects(projects);
                VeritasUtils.showAlert('Proyectos cargados exitosamente', 'success');
                
            } catch (error) {
                console.error('Error loading projects:', error);
                VeritasUtils.showAlert('Error al cargar proyectos', 'error');
            } finally {
                VeritasUtils.hideLoading();
            }
        }

        function renderProjects(projects) {
            const projectsList = document.getElementById('projectsList');
            projectsList.innerHTML = projects.map(project => {
                const providers = project.providers || {};
                const providerStatus = `
                    <div class="flex gap-1 mt-2">
                        <span class="badge ${providers.repository_synced ? 'badge-success' : 'badge-error'}">
                            ${providers.repository_synced ? '‚úÖ' : '‚ùå'} Repository
                        </span>
                        <span class="badge ${providers.github_connected ? 'badge-success' : 'badge-error'}">
                            ${providers.github_connected ? '‚úÖ' : '‚ùå'} GitHub
                        </span>
                        <span class="badge ${providers.tasks_created ? 'badge-success' : 'badge-error'}">
                            ${providers.tasks_created ? '‚úÖ' : '‚ùå'} Tasks
                        </span>
                    </div>
                `;
                
                return `
                <div class="service-card">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3>${project.name}</h3>
                            <p class="text-secondary mb-2">${project.description}</p>
                            <p><strong>Repositorio:</strong> <a href="${project.repository}" target="_blank" class="text-primary">${project.repository}</a></p>
                            ${providerStatus}
                        </div>
                        <div class="badge badge-success">${project.status}</div>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <span class="badge badge-primary">Historias: ${(project.user_stories || []).length}</span>
                        <span class="badge badge-primary">Planes: ${(project.test_plans || []).length}</span>
                        <span class="badge badge-primary">Creado: ${VeritasUtils.formatDate(project.created_at)}</span>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <button onclick="analyzeProject('${project.id}')" class="btn">üîç Analizar</button>
                        <button onclick="viewDashboard('${project.id}')" class="btn btn-secondary">üìä Dashboard</button>
                        <button onclick="viewReports('${project.id}')" class="btn btn-secondary">üìã Reportes</button>
                        <button onclick="checkProviders('${project.id}')" class="btn btn-secondary">üîó Providers</button>
                    </div>
                </div>
            `}).join('');
        }

        function createProject() {
            const formData = new FormData(document.getElementById('createProjectForm'));
            const data = {
                name: formData.get('name'),
                repository: formData.get('repository'),
                description: formData.get('description')
            };
            
            fetch('http://localhost:8874/api/projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(project => {
                VeritasUtils.hideModal('createModal');
                VeritasUtils.resetForm('createProjectForm');
                loadProjects();
                VeritasUtils.showAlert('Proyecto creado exitosamente', 'success');
            })
            .catch(error => {
                console.error('Error creating project:', error);
                VeritasUtils.showAlert('Error al crear el proyecto: ' + error.message, 'error');
            });
        }

        async function analyzeProject(projectId) {
            try {
                VeritasUtils.showLoading('Analizando proyecto...');
                const result = await VeritasUtils.post('projectManager', `/projects/${projectId}/analyze`, {});
                VeritasUtils.showAlert(`An√°lisis completado! Historias: ${result.user_stories.length}, Planes: ${result.test_plans.length}`, 'success');
                loadProjects();
            } catch (error) {
                console.error('Error analyzing project:', error);
                VeritasUtils.showAlert('Error al analizar el proyecto', 'error');
            } finally {
                VeritasUtils.hideLoading();
            }
        }

        function viewDashboard(projectId) {
            window.open(`http://localhost:8874/project/${projectId}/dashboard`, '_blank');
        }

        function viewReports(projectId) {
            window.open(`http://localhost:9898/minio/veritas-reports/projects/${projectId}/`, '_blank');
        }

        async function generateReport(projectId) {
            try {
                VeritasUtils.showLoading('Generando reporte...');
                // This would integrate with MinIO to generate and store reports
                const reportUrl = `http://localhost:9898/minio/veritas-reports/projects/${projectId}/latest-report.html`;
                VeritasUtils.showAlert('Reporte generado exitosamente', 'success');
                window.open(reportUrl, '_blank');
            } catch (error) {
                console.error('Error generating report:', error);
                VeritasUtils.showAlert('Error al generar el reporte', 'error');
            } finally {
                VeritasUtils.hideLoading();
            }
        }

        function checkProviders(projectId) {
            fetch('http://localhost:8874/api/providers/status')
                .then(response => response.json())
                .then(status => {
                    let statusText = 'Dev-Core Providers Status:\n\n';
                    Object.entries(status).forEach(([provider, info]) => {
                        const icon = info.status === 'healthy' ? '‚úÖ' : '‚ùå';
                        statusText += `${icon} ${provider}: ${info.status}\n`;
                    });
                    alert(statusText);
                })
                .catch(error => {
                    console.error('Error checking providers:', error);
                    alert('Error checking provider status');
                });
        }

        function exportProjects() {
            // Export functionality
            VeritasUtils.showAlert('Funci√≥n de exportaci√≥n en desarrollo', 'warning');
        }

        document.getElementById('createProjectForm').addEventListener('submit', (e) => {
            e.preventDefault();
            createProject();
        });

        // Load projects on page load
        loadProjects();
    </script>
</body>
</html>
