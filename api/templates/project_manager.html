<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Manager - IA-Ops Veritas</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .project-card {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary-color);
        }
        .project-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 2rem;
            width: 80%;
            max-width: 600px;
            border-radius: 1rem;
        }
        .form-group {
            margin: 1rem 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1>ðŸ“Š Project Manager</h1>
                <div class="subtitle">GestiÃ³n Masiva de Proyectos de Testing</div>
            </div>
            <nav class="nav">
                <button onclick="showCreateModal()" class="nav-item">+ Nuevo Proyecto</button>
                <a href="http://localhost:8869" class="nav-item">Portal Principal</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- Stats Section -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalProjects">0</div>
                <div class="stat-label">Proyectos Activos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalTestCases">0</div>
                <div class="stat-label">Casos de Prueba</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalUserStories">0</div>
                <div class="stat-label">Historias de Usuario</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">95%</div>
                <div class="stat-label">Tasa de Ã‰xito</div>
            </div>
        </section>

        <!-- Projects List -->
        <section>
            <h2 style="margin-bottom: 1.5rem;">Proyectos</h2>
            <div id="projectsList"></div>
        </section>
    </div>

    <!-- Create Project Modal -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <h3>Crear Nuevo Proyecto</h3>
            <form id="createProjectForm">
                <div class="form-group">
                    <label>Nombre del Proyecto:</label>
                    <input type="text" id="projectName" required>
                </div>
                <div class="form-group">
                    <label>URL del Repositorio:</label>
                    <input type="url" id="projectRepository" required placeholder="git@github.com:user/repo.git">
                </div>
                <div class="form-group">
                    <label>DescripciÃ³n:</label>
                    <textarea id="projectDescription" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" onclick="hideCreateModal()" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn">Crear Proyecto</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8874/api';
        const ANALYZER_API = 'http://localhost:8875/api';

        async function loadProjects() {
            try {
                const response = await fetch(`${API_BASE}/projects`);
                const projects = await response.json();
                
                document.getElementById('totalProjects').textContent = projects.length;
                
                let totalTestCases = 0;
                let totalUserStories = 0;
                
                projects.forEach(project => {
                    totalUserStories += (project.user_stories || []).length;
                    totalTestCases += (project.test_plans || []).reduce((sum, plan) => 
                        sum + (plan.test_cases || []).length, 0);
                });
                
                document.getElementById('totalTestCases').textContent = totalTestCases;
                document.getElementById('totalUserStories').textContent = totalUserStories;
                
                const projectsList = document.getElementById('projectsList');
                projectsList.innerHTML = projects.map(project => `
                    <div class="project-card">
                        <h3>${project.name}</h3>
                        <p><strong>Repositorio:</strong> ${project.repository}</p>
                        <p>${project.description}</p>
                        <div style="display: flex; gap: 1rem; margin: 1rem 0;">
                            <span class="provider-badge">Historias: ${(project.user_stories || []).length}</span>
                            <span class="provider-badge">Planes: ${(project.test_plans || []).length}</span>
                            <span class="provider-badge">Estado: ${project.status}</span>
                        </div>
                        <div class="project-actions">
                            <button onclick="analyzeProject('${project.id}')" class="btn">Analizar Repositorio</button>
                            <button onclick="viewDashboard('${project.id}')" class="btn btn-secondary">Dashboard</button>
                            <button onclick="generateReports('${project.id}')" class="btn btn-secondary">Reportes</button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }

        async function createProject(data) {
            try {
                const response = await fetch(`${API_BASE}/projects`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    hideCreateModal();
                    loadProjects();
                    alert('Proyecto creado exitosamente!');
                }
            } catch (error) {
                console.error('Error creating project:', error);
                alert('Error al crear el proyecto');
            }
        }

        async function analyzeProject(projectId) {
            try {
                const response = await fetch(`${API_BASE}/projects/${projectId}/analyze`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`AnÃ¡lisis completado!\nHistorias de Usuario: ${result.user_stories.length}\nPlanes de Prueba: ${result.test_plans.length}`);
                    loadProjects();
                }
            } catch (error) {
                console.error('Error analyzing project:', error);
                alert('Error al analizar el proyecto');
            }
        }

        function viewDashboard(projectId) {
            window.open(`/project/${projectId}/dashboard`, '_blank');
        }

        function generateReports(projectId) {
            window.open(`http://localhost:8873/project/${projectId}/reports`, '_blank');
        }

        function showCreateModal() {
            document.getElementById('createModal').style.display = 'block';
        }

        function hideCreateModal() {
            document.getElementById('createModal').style.display = 'none';
            document.getElementById('createProjectForm').reset();
        }

        document.getElementById('createProjectForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('projectName').value,
                repository: document.getElementById('projectRepository').value,
                description: document.getElementById('projectDescription').value
            };
            
            createProject(data);
        });

        // Load projects on page load
        loadProjects();
    </script>
</body>
</html>
