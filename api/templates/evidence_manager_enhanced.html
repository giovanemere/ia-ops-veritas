<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence Manager Enhanced - IA-Ops Veritas</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .evidence-grid {
            display: grid;
            grid-template-columns: 50px 200px 150px 100px 150px 200px 100px;
            gap: 1px;
            background: #ddd;
            border: 1px solid #ddd;
            margin: 20px 0;
        }
        .bulk-upload {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .drop-zone {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            background: #e3f2fd;
            border-color: #0056b3;
        }
        .evidence-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .evidence-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        .evidence-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
        }
        .evidence-card video {
            width: 100%;
            height: 120px;
            border-radius: 4px;
        }
        .file-type-icon {
            font-size: 48px;
            text-align: center;
            padding: 20px;
        }
        .batch-actions {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .upload-progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .upload-progress-bar {
            height: 100%;
            background: #28a745;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1>üìÅ Evidence Manager Enhanced</h1>
                <div class="subtitle">Gesti√≥n Masiva de Evidencias y Reportes</div>
            </div>
            <nav class="nav">
                <a href="http://localhost:8869" class="nav-item">Portal Principal</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- Batch Actions -->
        <div class="batch-actions">
            <button onclick="selectAll()" class="btn btn-secondary">‚úì Seleccionar Todo</button>
            <button onclick="downloadSelected()" class="btn btn-primary">üì• Descargar Seleccionados</button>
            <button onclick="deleteSelected()" class="btn btn-danger">üóëÔ∏è Eliminar Seleccionados</button>
            <button onclick="generateReport()" class="btn btn-success">üìä Generar Reporte</button>
            <button onclick="exportEvidence()" class="btn btn-info">üì¶ Exportar Evidencias</button>
            <select id="filterType" onchange="filterEvidence()">
                <option value="">Todos los tipos</option>
                <option value="screenshot">Screenshots</option>
                <option value="video">Videos</option>
                <option value="log">Logs</option>
                <option value="report">Reportes</option>
            </select>
        </div>

        <!-- Bulk Upload Zone -->
        <div class="bulk-upload">
            <h3>üì§ Subida Masiva de Evidencias</h3>
            <div class="drop-zone" id="dropZone">
                <div>
                    <h4>Arrastra archivos aqu√≠ o haz clic para seleccionar</h4>
                    <p>Soporta m√∫ltiples archivos: im√°genes, videos, logs, documentos</p>
                    <input type="file" id="fileInput" multiple accept="*/*" style="display: none;">
                    <button onclick="document.getElementById('fileInput').click()" class="btn btn-primary">
                        üìÅ Seleccionar Archivos
                    </button>
                </div>
            </div>
            
            <div id="uploadProgress" style="display: none;">
                <div class="upload-progress">
                    <div class="upload-progress-bar" id="progressBar"></div>
                </div>
                <div id="uploadStatus">Subiendo archivos...</div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalFiles">0</div>
                <div class="stat-label">Archivos Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSize">0 MB</div>
                <div class="stat-label">Tama√±o Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="selectedCount">0</div>
                <div class="stat-label">Seleccionados</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="recentUploads">0</div>
                <div class="stat-label">Subidos Hoy</div>
            </div>
        </div>

        <!-- Evidence Grid -->
        <div class="evidence-grid" id="evidenceGrid">
            <div class="grid-header">‚úì</div>
            <div class="grid-header">Nombre</div>
            <div class="grid-header">Tipo</div>
            <div class="grid-header">Tama√±o</div>
            <div class="grid-header">Fecha</div>
            <div class="grid-header">Ejecuci√≥n</div>
            <div class="grid-header">Acciones</div>
        </div>

        <!-- Evidence Preview -->
        <div class="evidence-preview" id="evidencePreview"></div>
    </div>

    <script>
        let evidenceFiles = [];
        let selectedFiles = new Set();

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupDropZone();
            loadEvidence();
        });

        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        async function handleFiles(files) {
            const fileArray = Array.from(files);
            if (fileArray.length === 0) return;

            const progressContainer = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const status = document.getElementById('uploadStatus');
            
            progressContainer.style.display = 'block';
            
            for (let i = 0; i < fileArray.length; i++) {
                const file = fileArray[i];
                const progress = ((i + 1) / fileArray.length) * 100;
                
                progressBar.style.width = `${progress}%`;
                status.textContent = `Subiendo: ${file.name} (${i + 1}/${fileArray.length})`;
                
                try {
                    await uploadFile(file);
                } catch (error) {
                    console.error(`Error uploading ${file.name}:`, error);
                }
            }
            
            progressContainer.style.display = 'none';
            loadEvidence();
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('project_id', '1');
            formData.append('execution_id', '1');
            
            // Simulate upload (replace with actual API call)
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Add to local evidence array for demo
            const evidence = {
                id: Date.now() + Math.random(),
                file_name: file.name,
                file_type: getFileType(file.name),
                file_size: file.size,
                uploaded_at: new Date().toISOString(),
                execution_name: 'Batch Upload',
                file_url: URL.createObjectURL(file)
            };
            
            evidenceFiles.push(evidence);
        }

        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const types = {
                'png': 'screenshot', 'jpg': 'screenshot', 'jpeg': 'screenshot', 'gif': 'screenshot',
                'mp4': 'video', 'avi': 'video', 'mov': 'video', 'webm': 'video',
                'txt': 'log', 'log': 'log', 'json': 'log',
                'pdf': 'report', 'doc': 'report', 'docx': 'report', 'html': 'report'
            };
            return types[ext] || 'document';
        }

        async function loadEvidence() {
            try {
                const response = await fetch('http://localhost:8869/api/evidence');
                const apiEvidence = await response.json();
                
                // Combine API evidence with uploaded files
                evidenceFiles = [...apiEvidence, ...evidenceFiles.filter(f => f.id > 1000000)];
                
            } catch (error) {
                console.error('Error loading evidence:', error);
                // Use only local files if API fails
            }
            
            renderEvidenceGrid();
            renderEvidencePreview();
            updateStats();
        }

        function renderEvidenceGrid() {
            const grid = document.getElementById('evidenceGrid');
            
            // Clear existing rows (keep headers)
            const headers = grid.querySelectorAll('.grid-header');
            grid.innerHTML = '';
            headers.forEach(header => grid.appendChild(header));

            evidenceFiles.forEach((evidence, index) => {
                addEvidenceRow(evidence, index);
            });
        }

        function addEvidenceRow(evidence, index) {
            const grid = document.getElementById('evidenceGrid');
            
            // Checkbox
            const checkbox = document.createElement('div');
            checkbox.className = 'grid-cell';
            checkbox.innerHTML = `<input type="checkbox" data-index="${index}" onchange="toggleSelection(${index})">`;
            
            // Name
            const name = document.createElement('div');
            name.className = 'grid-cell';
            name.textContent = evidence.file_name || 'Unknown';
            
            // Type
            const type = document.createElement('div');
            type.className = 'grid-cell';
            type.innerHTML = `<span class="badge">${evidence.file_type || 'unknown'}</span>`;
            
            // Size
            const size = document.createElement('div');
            size.className = 'grid-cell';
            size.textContent = formatFileSize(evidence.file_size || 0);
            
            // Date
            const date = document.createElement('div');
            date.className = 'grid-cell';
            date.textContent = formatDate(evidence.uploaded_at);
            
            // Execution
            const execution = document.createElement('div');
            execution.className = 'grid-cell';
            execution.textContent = evidence.execution_name || 'N/A';
            
            // Actions
            const actions = document.createElement('div');
            actions.className = 'grid-cell';
            actions.innerHTML = `
                <button onclick="viewEvidence(${index})" class="btn btn-sm">üëÅÔ∏è</button>
                <button onclick="downloadEvidence(${index})" class="btn btn-sm">üì•</button>
                <button onclick="deleteEvidence(${index})" class="btn btn-sm btn-danger">üóëÔ∏è</button>
            `;
            
            grid.appendChild(checkbox);
            grid.appendChild(name);
            grid.appendChild(type);
            grid.appendChild(size);
            grid.appendChild(date);
            grid.appendChild(execution);
            grid.appendChild(actions);
        }

        function renderEvidencePreview() {
            const preview = document.getElementById('evidencePreview');
            preview.innerHTML = '';
            
            evidenceFiles.slice(0, 12).forEach((evidence, index) => {
                const card = document.createElement('div');
                card.className = 'evidence-card';
                
                let content = '';
                if (evidence.file_type === 'screenshot') {
                    content = `<img src="${evidence.file_url || '/api/evidence/' + evidence.id + '/download'}" alt="${evidence.file_name}">`;
                } else if (evidence.file_type === 'video') {
                    content = `<video controls><source src="${evidence.file_url || '/api/evidence/' + evidence.id + '/download'}"></video>`;
                } else {
                    const icons = {
                        'log': 'üìÑ',
                        'report': 'üìä',
                        'document': 'üìã'
                    };
                    content = `<div class="file-type-icon">${icons[evidence.file_type] || 'üìÅ'}</div>`;
                }
                
                card.innerHTML = `
                    ${content}
                    <h4>${evidence.file_name}</h4>
                    <p>${evidence.file_type} ‚Ä¢ ${formatFileSize(evidence.file_size)}</p>
                    <p>${formatDate(evidence.uploaded_at)}</p>
                `;
                
                preview.appendChild(card);
            });
        }

        function toggleSelection(index) {
            if (selectedFiles.has(index)) {
                selectedFiles.delete(index);
            } else {
                selectedFiles.add(index);
            }
            updateStats();
        }

        function selectAll() {
            const checkboxes = document.querySelectorAll('#evidenceGrid input[type="checkbox"]');
            const allSelected = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach((cb, index) => {
                cb.checked = !allSelected;
                if (!allSelected) {
                    selectedFiles.add(index);
                } else {
                    selectedFiles.delete(index);
                }
            });
            
            updateStats();
        }

        function downloadSelected() {
            if (selectedFiles.size === 0) {
                alert('Selecciona al menos un archivo');
                return;
            }
            
            selectedFiles.forEach(index => {
                downloadEvidence(index);
            });
        }

        function deleteSelected() {
            if (selectedFiles.size === 0) {
                alert('Selecciona al menos un archivo');
                return;
            }
            
            if (confirm(`¬øEliminar ${selectedFiles.size} archivos seleccionados?`)) {
                const indicesToDelete = Array.from(selectedFiles).sort((a, b) => b - a);
                indicesToDelete.forEach(index => {
                    evidenceFiles.splice(index, 1);
                });
                
                selectedFiles.clear();
                renderEvidenceGrid();
                renderEvidencePreview();
                updateStats();
            }
        }

        function viewEvidence(index) {
            const evidence = evidenceFiles[index];
            const url = evidence.file_url || `/api/evidence/${evidence.id}/download`;
            window.open(url, '_blank');
        }

        function downloadEvidence(index) {
            const evidence = evidenceFiles[index];
            const url = evidence.file_url || `/api/evidence/${evidence.id}/download`;
            
            const a = document.createElement('a');
            a.href = url;
            a.download = evidence.file_name;
            a.click();
        }

        function deleteEvidence(index) {
            if (confirm('¬øEliminar este archivo?')) {
                evidenceFiles.splice(index, 1);
                renderEvidenceGrid();
                renderEvidencePreview();
                updateStats();
            }
        }

        function filterEvidence() {
            const filterType = document.getElementById('filterType').value;
            const filteredFiles = filterType ? 
                evidenceFiles.filter(f => f.file_type === filterType) : 
                evidenceFiles;
            
            // Re-render with filtered files
            const originalFiles = evidenceFiles;
            evidenceFiles = filteredFiles;
            renderEvidenceGrid();
            renderEvidencePreview();
            evidenceFiles = originalFiles;
        }

        function generateReport() {
            const reportData = {
                total_files: evidenceFiles.length,
                by_type: {},
                total_size: evidenceFiles.reduce((sum, f) => sum + (f.file_size || 0), 0),
                date_range: {
                    from: evidenceFiles.length > 0 ? Math.min(...evidenceFiles.map(f => new Date(f.uploaded_at))) : null,
                    to: new Date()
                }
            };
            
            evidenceFiles.forEach(f => {
                reportData.by_type[f.file_type] = (reportData.by_type[f.file_type] || 0) + 1;
            });
            
            const reportHtml = `
                <h2>üìä Reporte de Evidencias</h2>
                <p><strong>Total de archivos:</strong> ${reportData.total_files}</p>
                <p><strong>Tama√±o total:</strong> ${formatFileSize(reportData.total_size)}</p>
                <h3>Por tipo:</h3>
                <ul>
                    ${Object.entries(reportData.by_type).map(([type, count]) => 
                        `<li>${type}: ${count} archivos</li>`
                    ).join('')}
                </ul>
                <p><strong>Generado:</strong> ${new Date().toLocaleString()}</p>
            `;
            
            const newWindow = window.open('', '_blank');
            newWindow.document.write(reportHtml);
        }

        function exportEvidence() {
            const csvContent = [
                ['Nombre', 'Tipo', 'Tama√±o', 'Fecha', 'Ejecuci√≥n'],
                ...evidenceFiles.map(f => [
                    f.file_name,
                    f.file_type,
                    f.file_size,
                    f.uploaded_at,
                    f.execution_name || ''
                ])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `evidence_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function updateStats() {
            document.getElementById('totalFiles').textContent = evidenceFiles.length;
            
            const totalSize = evidenceFiles.reduce((sum, f) => sum + (f.file_size || 0), 0);
            document.getElementById('totalSize').textContent = formatFileSize(totalSize);
            
            document.getElementById('selectedCount').textContent = selectedFiles.size;
            
            const today = new Date().toDateString();
            const recentUploads = evidenceFiles.filter(f => 
                new Date(f.uploaded_at).toDateString() === today
            ).length;
            document.getElementById('recentUploads').textContent = recentUploads;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString();
        }
    </script>
</body>
</html>
